
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Wei Shi</title>
	<meta name="author" content="Wei Shi">

	
	<meta name="description" content="Jul 24th, 2013 Octopress,, github Setup an Existing Octopress Repository After Git Clone The Problem It seems all the tutorial on Octopress deals &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Wei Shi" type="application/atom+xml">
	
	<link rel="canonical" href="http://weishi.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="/javascripts/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("weishi@stanford.edu") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
</div>
<hgroup>
  <h1><a href="/">Wei Shi</a></h1>
  
</hgroup>

<p class="subtitle"></p>
<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://careers.stackoverflow.com/weishi">About Me</a></li>
</ul>


<section class="aboutme">
  <p>
    A master student in Computer Science at Stanford University
  </p>
</section>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/115577913983351297851" rel="author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/overmindxp" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/weishi" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-07-24T07:25:00-07:00" data-updated="true" itemprop="datePublished">Jul 24<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/octopress/'>Octopress,</a>, <a class='category' href='/blog/categories/github/'>github</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/07/24/setup-an-existing-octopress-repository-after-git-clone/" itemprop="url">Setup an Existing Octopress Repository After Git Clone</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h2>The Problem</h2>

<p>It seems all the tutorial on Octopress deals with setting up a new repository.
Recently, I needed to clone the my Octopress repo on a new machine and
resume writing there. I thought it would be as simple as
<code>git clone</code>, <code>rake setup_getihub_pages</code>, <code>rake new_post</code>, and <code>rake gen_deploy</code>.
However I encourtered the following during deploy</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>To https://github.com/username/username.github.io
</span><span class='line'> ! [rejected]        master -&gt; master (non-fast-forward)
</span><span class='line'> error: failed to push some refs to 'https://github.com/username/username.github.io'
</span><span class='line'> hint: Updates were rejected because the tip of your current branch is behind
</span><span class='line'> hint: its remote counterpart. Merge the remote changes (e.g. 'git pull')
</span><span class='line'> hint: before pushing again.
</span><span class='line'> hint: See the 'Note about fast-forwards' in 'git push --help' for details.
</span><span class='line'>
</span><span class='line'>## Github Pages deploy complete
</span><span class='line'>cd -</span></code></pre></td></tr></table></div></figure>


<h2>The Fix</h2>

<p>I googled around and found no solution.
After digging into the Rakefile, I came up with a manual fix.
Basically, you need to create and link the <code>deploy</code> directory to <code>master</code> branch.</p>

<p>First, we clone the repo and switch to the correct branch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/username/username.github.io.git
</span><span class='line'>git checkout source</span></code></pre></td></tr></table></div></figure>


<p>Then we need to setup the <code>deploy</code> directory.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir _deploy
</span><span class='line'>cd _deploy
</span><span class='line'>git init
</span><span class='line'>git remote add -t master -f origin https://github.com/username/username.github.io.git</span></code></pre></td></tr></table></div></figure>


<p>Done! Now we can make changes in <code>source</code> branch and use <code>rake gen_deploy</code> as usual.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-07-19T14:45:00-07:00" data-updated="true" itemprop="datePublished">Jul 19<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/jailbreak/'>Jailbreak</a>, <a class='category' href='/blog/categories/iphone/'>iPhone</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/07/19/fixing-find-my-friends-location-shift-in-china/" itemprop="url">Fixing Find My Friends Location Shift in China</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Since China uses a different coordinate system,
the common latitude/longitude coordinates obtained from GPS or iOS <code>CoreLocation</code> service
will not map to the correct location in China.
The shift is usually 500+ meters, which renders the FindMyFriends app useless.
In order to let your (unjailbroken) friends see your true location,
your reported location need to be shifted.
When they receive your (shifted) location and apply it to a shifted map,
the shift effect cancels out and they see your true location in MapView.</p>

<p><code>FindMyFriends.app</code> reports user location from two places.</p>

<ul>
<li><p>When the app is in <strong>foreground</strong>, the app itself reports the location.</p></li>
<li><p>When the app is in <strong>background</strong>, <code>aosnotifyd</code> daemon will respond to the location request.
(This daemon is also responsible for <code>FindMyiPhone.app</code> location tracking.)</p></li>
</ul>


<p>Therefore to fix the location shift, those two places need to be patched.</p>

<h2>com.apple.mobileme.fmf1</h2>

<p>In <code>FindMyFriends.app</code>, the following function does the reporting:</p>

<figure class='code'><figcaption><span>ServerInteractionController.h:</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendMyLocation:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">location</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using <code>theos</code>, we can hook into the method and modify the <code>(id)location</code>.</p>

<p>However, we can fix friends location altogether by hooking the location data
structure directly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">%</span><span class="n">hook</span> <span class="n">FMFLocation</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">updateLatitude:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">lat</span> <span class="nl">longitude:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">lng</span> <span class="nl">altitude:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">alt</span>
</span><span class='line'><span class="nl">horizontalAccuracy:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">acc</span> <span class="nl">verticalAccuracy:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">acc5</span> <span class="nl">course:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">c</span> <span class="nl">speed:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">s</span> <span class="nl">timestamp:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">ts</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">double</span> <span class="n">nlat</span><span class="p">,</span><span class="n">nlng</span><span class="p">;</span>
</span><span class='line'>    <span class="n">transform</span><span class="p">([</span><span class="n">lat</span> <span class="n">doubleValue</span><span class="p">],[</span><span class="n">lng</span> <span class="n">doubleValue</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">nlat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nlng</span><span class="p">);</span>
</span><span class='line'>    <span class="n">NSNumber</span> <span class="o">*</span><span class="n">olat</span><span class="o">=</span><span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithDouble:</span><span class="n">nlat</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSNumber</span> <span class="o">*</span><span class="n">olng</span><span class="o">=</span><span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithDouble:</span><span class="n">nlng</span><span class="p">];</span>
</span><span class='line'>    <span class="o">%</span><span class="n">orig</span><span class="p">(</span><span class="n">olat</span><span class="p">,</span><span class="n">olng</span><span class="p">,</span><span class="n">alt</span><span class="p">,</span><span class="n">acc</span><span class="p">,</span><span class="n">acc5</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">ts</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">%</span><span class="n">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>com.apple.aosnotifyd</h2>

<p>In <code>aosnotifyd</code>, the following function does the reporting:</p>

<figure class='code'><figcaption><span>AOSFindBaseServiceProvider.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">sendCurrentLocation:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">fp8</span> <span class="nf">isFinished:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">fp1</span> <span class="nf">forCmd:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">fp2</span> <span class="nf">withReason:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">fp3</span> <span class="nf">andAccuracyChange:</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="nv">fp4</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This can be patched similarly.</p>

<h2>Location shift function</h2>

<p>For some reason, I will not discuss the detail of the shift function <code>transform()</code>.
Basically it does the conversion from WGS-84(GPS) to GCJ-02 coordinates.
Google <code>WGS2GCJ</code> for more information.</p>

<h2>Source code</h2>

<p>You can download and build the cydia tweak from my repository:
<a href="https://github.com/weishi/FMFChinaLocationPatch">github.com/weishi/FMFChinaLocationPatch</a></p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2013 - Wei Shi -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'weishigithub';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-42690127-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>




		</div>
	</div>
</body>
</html>
